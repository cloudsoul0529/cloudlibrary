<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.seventhgroup.dao.BookMapper">

    <!-- 定义结果映射 -->
    <resultMap id="bookMap" type="Book">
        <id column="book_id" property="id"/>
        <result column="book_name" property="name"/>
        <result column="book_isbn" property="isbn"/>
        <result column="book_press" property="press"/>
        <result column="book_author" property="author"/>
        <result column="book_pagination" property="pagination"/>
        <result column="book_price" property="price"/>
        <result column="book_uploadtime" property="uploadTime"/>
        <result column="book_status" property="status"/>
        <result column="book_borrower" property="borrower"/>
        <result column="book_borrowtime" property="borrowTime"/>
        <result column="book_returntime" property="returnTime"/>
    </resultMap>

    <!-- 查询新书（按上传时间降序） -->
    <select id="selectNewBooks" resultMap="bookMap">
        SELECT
            book_id,
            book_name,
            book_isbn,
            book_press,
            book_author,
            book_pagination,
            book_price,
            book_uploadtime,
            book_status,
            book_borrower,
            book_borrowtime,
            book_returntime
        FROM book
        WHERE book_status != ${@org.seventhgroup.pojo.Book@REMOVED}
        ORDER BY book_uploadtime DESC
    </select>

    <!-- 根据id查询图书信息 -->
    <select id="findById" resultMap="bookMap">
        SELECT
            book_id,
            book_name,
            book_isbn,
            book_press,
            book_author,
            book_pagination,
            book_price,
            book_uploadtime,
            book_status,
            book_borrower,
            book_borrowtime,
            book_returntime
        FROM book
        WHERE book_id = #{id}
    </select>

    <!-- 分页查询图书 -->
    <select id="searchBooks" resultMap="bookMap">
        SELECT
        book_id,
        book_name,
        book_isbn,
        book_press,
        book_author,
        book_pagination,
        book_price,
        book_uploadtime,
        book_status,
        book_borrower,
        book_borrowtime,
        book_returntime
        FROM book
        WHERE book_status != ${@org.seventhgroup.pojo.Book@REMOVED}
        <if test="name != null">
            AND book_name LIKE CONCAT('%', #{name}, '%')
        </if>
        <if test="press != null">
            AND book_press LIKE CONCAT('%', #{press}, '%')
        </if>
        <if test="author != null">
            AND book_author LIKE CONCAT('%', #{author}, '%')
        </if>
        ORDER BY book_status, book_borrowtime, book_uploadtime
    </select>

    <!-- 新增图书 -->
    <insert id="addBook">
        INSERT INTO book(
            book_id,
            book_name,
            book_isbn,
            book_press,
            book_author,
            book_pagination,
            book_price,
            book_uploadtime,
            book_status,
            book_borrower,
            book_borrowtime,
            book_returntime
        ) VALUES (
                     #{id},
                     #{name},
                     #{isbn},
                     #{press},
                     #{author},
                     #{pagination},
                     #{price},
                     #{uploadTime},
                     #{status},
                     #{borrower},
                     #{borrowTime},
                     #{returnTime}
                 )
    </insert>

    <!-- 修改图书信息 -->
    <update id="editBook">
        UPDATE book
        <trim prefix="SET" suffixOverrides=",">
            <if test="name != null">
                book_name = #{name},
            </if>
            <if test="isbn != null">
                book_isbn = #{isbn},
            </if>
            <if test="press != null">
                book_press = #{press},
            </if>
            <if test="author != null">
                book_author = #{author},
            </if>
            <if test="pagination != null">
                book_pagination = #{pagination},
            </if>
            <if test="price != null">
                book_price = #{price},
            </if>
            <if test="uploadTime != null">
                book_uploadtime = #{uploadTime},
            </if>
            <if test="status != null">
                book_status = #{status},
            </if>
            <if test="borrower != null">
                book_borrower = #{borrower},
            </if>
            <if test="borrowTime != null">
                book_borrowtime = #{borrowTime},
            </if>
            <if test="returnTime != null">
                book_returntime = #{returnTime}
            </if>
        </trim>
        WHERE book_id = #{id}
    </update>

    <!-- 管理员查询：通用查询 (支持指定状态) -->
    <select id="selectBorrowed" resultMap="bookMap">
        SELECT * FROM book
        <where>
            <if test="status != null and status != ''">
                AND book_status = #{status}
            </if>
            <if test="status == null or status == ''">
                AND book_status IN('1','2')
            </if>

            <if test="name != null and name != ''">
                AND book_name LIKE CONCAT('%', #{name}, '%')
            </if>
            <if test="press != null and press != ''">
                AND book_press LIKE CONCAT('%', #{press}, '%')
            </if>
            <if test="author != null and author != ''">
                AND book_author LIKE CONCAT('%', #{author}, '%')
            </if>
            <if test="borrower != null and borrower != ''">
                AND book_borrower LIKE CONCAT('%', #{borrower}, '%')
            </if>
        </where>
        ORDER BY book_borrowtime DESC
    </select>

    <!-- 查询借阅但未归还的图书 -->
    <select id="selectMyBorrowed" resultMap="bookMap">
        SELECT
        book_id,
        book_name,
        book_isbn,
        book_press,
        book_author,
        book_pagination,
        book_price,
        book_uploadtime,
        book_status,
        book_borrower,
        book_borrowtime,
        book_returntime
        FROM book
        WHERE book_borrower = #{borrower}
        AND book_status IN (${@org.seventhgroup.pojo.Book@BORROWED}, ${@org.seventhgroup.pojo.Book@RETURNING})
        <if test="name != null">
            AND book_name LIKE CONCAT('%', #{name}, '%')
        </if>
        <if test="press != null">
            AND book_press LIKE CONCAT('%', #{press}, '%')
        </if>
        <if test="author != null">
            AND book_author LIKE CONCAT('%', #{author}, '%')
        </if>
        ORDER BY book_borrowtime
    </select>

    <!-- 统计待归还确认的数量 -->
    <select id="countByStatus" resultType="java.lang.Integer">
        SELECT count(*) FROM book WHERE book_status = #{status}
    </select>

</mapper>
