<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.seventhgroup.dao.BookMapper">

    <!-- 定义结果映射 -->
    <resultMap id="bookMap" type="Book">
        <id column="book_id" property="id"/>
        <result column="book_name" property="name"/>
        <result column="book_isbn" property="isbn"/>
        <result column="book_press" property="press"/>
        <result column="book_author" property="author"/>
        <result column="book_pagination" property="pagination"/>
        <result column="book_price" property="price"/>
        <result column="book_uploadtime" property="uploadTime"/>
        <result column="book_status" property="status"/>
        <result column="book_borrower" property="borrower"/>
        <result column="book_borrowtime" property="borrowTime"/>
        <result column="book_returntime" property="returnTime"/>
    </resultMap>

    <!-- 查询新书（按上传时间降序） -->
    <select id="selectNewBooks" resultMap="bookMap">
        SELECT
            book_id,
            book_name,
            book_isbn,
            book_press,
            book_author,
            book_pagination,
            book_price,
            book_uploadtime,
            book_status,
            book_borrower,
            book_borrowtime,
            book_returntime
        FROM book
        WHERE book_status != ${@org.seventhgroup.pojo.Book@REMOVED}
        ORDER BY book_uploadtime DESC
    </select>

    <!-- 根据id查询图书信息 -->
    <select id="findById" resultMap="bookMap">
        SELECT
            book_id,
            book_name,
            book_isbn,
            book_press,
            book_author,
            book_pagination,
            book_price,
            book_uploadtime,
            book_status,
            book_borrower,
            book_borrowtime,
            book_returntime
        FROM book
        WHERE book_id = #{id}
    </select>

    <!-- 分页查询图书 -->
    <select id="searchBooks" resultMap="bookMap">
        SELECT
        book_id,
        book_name,
        book_isbn,
        book_press,
        book_author,
        book_pagination,
        book_price,
        book_uploadtime,
        book_status,
        book_borrower,
        book_borrowtime,
        book_returntime
        FROM book
        WHERE book_status != ${@org.seventhgroup.pojo.Book@REMOVED}
        <if test="name != null">
            AND book_name LIKE CONCAT('%', #{name}, '%')
        </if>
        <if test="press != null">
            AND book_press LIKE CONCAT('%', #{press}, '%')
        </if>
        <if test="author != null">
            AND book_author LIKE CONCAT('%', #{author}, '%')
        </if>
        ORDER BY book_borrowtime
    </select>

    <!-- 新增图书 -->
    <insert id="addBook">
        INSERT INTO book(
            book_id,
            book_name,
            book_isbn,
            book_press,
            book_author,
            book_pagination,
            book_price,
            book_uploadtime,
            book_status,
            book_borrower,
            book_borrowtime,
            book_returntime
        ) VALUES (
                     #{id},
                     #{name},
                     #{isbn},
                     #{press},
                     #{author},
                     #{pagination},
                     #{price},
                     #{uploadTime},
                     #{status},
                     #{borrower},
                     #{borrowTime},
                     #{returnTime}
                 )
    </insert>

    <!-- 修改图书信息 -->
    <update id="editBook">
        UPDATE book
        <trim prefix="SET" suffixOverrides=",">
            <if test="name != null">
                book_name = #{name},
            </if>
            <if test="isbn != null">
                book_isbn = #{isbn},
            </if>
            <if test="press != null">
                book_press = #{press},
            </if>
            <if test="author != null">
                book_author = #{author},
            </if>
            <if test="pagination != null">
                book_pagination = #{pagination},
            </if>
            <if test="price != null">
                book_price = #{price},
            </if>
            <if test="uploadTime != null">
                book_uploadtime = #{uploadTime},
            </if>
            <if test="status != null">
                book_status = #{status},
            </if>
            <if test="borrower != null">
                book_borrower = #{borrower},
            </if>
            <if test="borrowTime != null">
                book_borrowtime = #{borrowTime},
            </if>
            <if test="returnTime != null">
                book_returntime = #{returnTime}
            </if>
        </trim>
        WHERE book_id = #{id}
    </update>

    <!-- 查询借阅但未归还的图书和待归还确认的图书 -->
<!--    <select id="selectBorrowed" resultMap="bookMap">-->
<!--        SELECT-->
<!--        book_id,-->
<!--        book_name,-->
<!--        book_isbn,-->
<!--        book_press,-->
<!--        book_author,-->
<!--        book_pagination,-->
<!--        book_price,-->
<!--        book_uploadtime,-->
<!--        book_status,-->
<!--        book_borrower,-->
<!--        book_borrowtime,-->
<!--        book_returntime-->
<!--        FROM book-->
<!--        WHERE(-->
<!--        (book_borrower = #{borrower} AND book_status = ${@org.seventhgroup.pojo.Book@BORROWED})-->
<!--        OR-->
<!--        (book_status = ${@org.seventhgroup.pojo.Book@RETURNING})-->
<!--        )-->
<!--        <if test="name != null">-->
<!--            AND book_name LIKE CONCAT('%', #{name}, '%')-->
<!--        </if>-->
<!--        <if test="press != null">-->
<!--            AND book_press LIKE CONCAT('%', #{press}, '%')-->
<!--        </if>-->
<!--        <if test="author != null">-->
<!--            AND book_author LIKE CONCAT('%', #{author}, '%')-->
<!--        </if>-->
<!--        ORDER BY book_borrowtime-->
<!--    </select>-->

    <!-- 管理员查询专用：查询所有借出(1)和归还中(2)的书 -->
    <select id="selectBorrowed" resultMap="bookMap">
        SELECT * FROM book
        WHERE book_status != '0'  <!-- 核心逻辑：只要状态不是0(可借阅)，说明书都在外面，都要查 -->

        <!-- 下面是动态查询条件 -->
        <if test="name != null and name != ''">
            AND book_name LIKE CONCAT('%', #{name}, '%')
        </if>
        <if test="press != null and press != ''">
            AND book_press LIKE CONCAT('%', #{press}, '%')
        </if>
        <if test="author != null and author != ''">
            AND book_author LIKE CONCAT('%', #{author}, '%')
        </if>

        <!-- 关键点：借阅人查询。
             只有当管理员在输入框输了名字，这里才生效。
             没输名字时 borrower为空，这个条件不执行，就能查出所有人！ -->
        <if test="borrower != null and borrower != ''">
            AND book_borrower LIKE CONCAT('%', #{borrower}, '%')
        </if>

        ORDER BY book_borrowtime DESC
    </select>


    <!-- 查询借阅但未归还的图书 -->
    <select id="selectMyBorrowed" resultMap="bookMap">
        SELECT
        book_id,
        book_name,
        book_isbn,
        book_press,
        book_author,
        book_pagination,
        book_price,
        book_uploadtime,
        book_status,
        book_borrower,
        book_borrowtime,
        book_returntime
        FROM book
        WHERE book_borrower = #{borrower}
        AND book_status IN (${@org.seventhgroup.pojo.Book@BORROWED}, ${@org.seventhgroup.pojo.Book@RETURNING})
        <if test="name != null">
            AND book_name LIKE CONCAT('%', #{name}, '%')
        </if>
        <if test="press != null">
            AND book_press LIKE CONCAT('%', #{press}, '%')
        </if>
        <if test="author != null">
            AND book_author LIKE CONCAT('%', #{author}, '%')
        </if>
        ORDER BY book_borrowtime
    </select>

</mapper>
